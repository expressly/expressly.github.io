- id: flows
  title: Flows
  description:
    - For the following flows, the following defined Actors have been used
    - SERVER - Expressly API Server.
    - STORE - The store/integration Expressly is being configured with.
    - CUSTOMER - The customer interacting with the store using their browser.
  children:
    - id: flows_user_migration
      title: User Campaign Migration
      description:
      template: rest_api/flow.html
      preconditions:
        - A campaign has been created and is active.
      flow:
        1: CUSTOMER navigates to provided link with unique uuid attached (<a href="#responses_popup">Show Popup</a>).
        2: STORE requests popup for unique uuid (<a href="#requests_migration_popup">Get Campaign Migration Popup</a>).
        3: SERVER returns popup html rendered for the given campaign, and CUSTOMER.
        4: STORE renders html atop a given store page (e.g. homepage).
        5: CUSTOMER accepts terms & conditions, and privacy policy by pressing "OK" which will start migration.
        6: CUSTOMER navigates to <a href="#responses_migrate_user">Migrate User</a>.
        7: STORE requests CUSTOMER information from SERVER
        8: SERVER returns information associated with CUSTOMER.
        9: STORE adds customer to their store; adds product, and coupon (if provided, and supported) to cart.
        10: STORE tells SERVER that CUSTOMER has been migrated correctly (<a href="#requests_migration_success">Migration Success</a>).
        11: STORE logs user in, and navigates to homepage.
      alternate:
        8.1: CUSTOMER already exists, STORE tells SERVER that CUSTOMER has been migrated previously (<a href="#requests_migration_success">Migration Success</a>).
        9.1: STORE adds product, and coupon (if provided, and supported) to cart.
        10.1: STORE shows CUSTOMER message that they already exist, asking if they would like to be redirected to the login page.
        11.1: CUSTOMER accepts confirm message, and is redirected to the STORE login page.
    - id: flows_purchases
      title: Check Purchases
      description:
      template: rest_api/flow.html
      flow:
        1: SERVER makes a request to STORE endpoint, <a href="#responses_batch_invoices">Invoices for Customer Purchases</a>.
        2: STORE compares emails, and period to gather purchase information for provided email addresses.
        3: STORE returns compiled data to SERVER.
    - id: flows_migration
      title: Check Customer Migration
      description:
      template: rest_api/flow.html
      flow:
        1: SERVER makes a request to STORE endpoint, <a href="#responses_batch_customers">Customers on Store</a>.
        2: STORE compares emails to determine wether an emails has been migrated to the STORE.
        3: STORE returns compiled data to the SERVER.
#    - id: flows_banner
#      title: Campaign Banner
#      description:
#      template: rest_api/flow.html
#      preconditions:
#        - None
#      flow:
#        1: STORE requests banner from SERVER (<a href="#requests_campaign_banner">Get Campaign Banner</a>).
#        2: SERVER returns image, and url.
#        3: STORE displays banner on page.
#        4: Banner is clicked on, redirecting CUSTOMER to provided url.
- id: requests
  title: Requests
  description: Interacting with us.
  children:
    - id: requests_migration_popup
      title: Get Campaign Migration Popup
      template: rest_api/route.html
      route: /api/v2/migration/{uuid}
      parameters:
        uuid: String
      method: GET
      request:
        requester: STORE
        authorization: true
        headers:
          - "Content-Type: application/json" 
      response:
        responder: SERVER
        headers:
          - Content-Type "text/html"
        status:
          200:
    - id: requests_migration_data
      title: Get Campaign Migration Data
      template: rest_api/route.html
      route: /api/v2/migration/{uuid}/user
      parameters:
        uuid: String
      method: GET
      request:
        requester: STORE
        authorization: true
        headers:
          - "Content-Type: application/json" 
      response:
        responder: SERVER
        headers:
          - "Content-Type: application/json" 
        status:
          200:
          400:
        example: >
          {
              "meta": {
                  "locale": "UKR",
                  "sender": "https://expresslyapp.com/api/v1/migration/{uuid}"
              },
              "data": {
                  "email": "john.smith@gmail.com",
                  "customerData": {
                      "firstName": "John",
                      "lastName": "Smith",
                      "gender": "M",
                      "billingAddress": 0,
                      "shippingAddress": 1,
                      "company": "Expressly",
                      "dob": "1987-08-07",
                      "taxNumber": "GB0249894821",
                      "onlinePresence": [
                          {
                              "field": "website",
                              "value": "http://www.myblog.com"
                          }
                      ],
                      "dateUpdated": "2015-07-10T11:42:00+01:00",
                      "emails": [
                          {
                              "email": "john.smith@gmail.com",
                              "alias": "default"
                          },
                          {
                              "email": "john@smithcorp.com",
                              "alias": "work"
                          }
                      ],
                      "phones": [
                          {
                              "type": "M",
                              "number": "020734581250",
                              "countryCode": 44
                          },
                          {
                              "type": "L",
                              "number": "020731443250",
                              "countryCode": 44
                          }
                      ],
                      "addresses": [
                          {
                              "firstName": "John",
                              "lastName": "Smith",
                              "address1": "12 Piccadilly",
                              "address2": "Room 14",
                              "city": "London",
                              "companyName": "WorkHard Ltd",
                              "zip": "W1C 34U",
                              "phone": 1,
                              "alias": "Work address",
                              "stateProvince": "LND",
                              "country": "GBR"
                          },
                          {
                              "firstName": "John C.",
                              "lastName": "Smith",
                              "address1": "23 Sallsberry Ave",
                              "address2": "Flat 3",
                              "city": "London",
                              "companyName": "",
                              "zip": "NW3 4HG",
                              "phone": 0,
                              "alias": "Home address",
                              "stateProvince": "LND",
                              "country": "GBR"
                          }
                      ]
                  },
                  "cart": {
                      "productId": "491",
                      "couponCode": "20OFF"
                  }
              }
          }
    - id: requests_migration_success
      title: Migration Success
      template: rest_api/route.html
      route: /api/v2/migration/{uuid}/success
      paramters:
        uuid: String
      method: GET
      request:
        requester: STORE
        authorization: true
        headers:
          - "Content-Type: application/json" 
      response:
        responder: SERVER
        headers:
          - "Content-Type: application/json" 
        status:
          200:
          400:
        example: >
          {
              "success": "true",
              "msg": ""
          }
#    - id: requests_campaign_banner
#      title: Campaign Banner
#      template: rest_api/route.html
#      route: /api/v2/banner/{uuid}?email={email}
#      paramters:
#        uuid: String
#        email: String
#      method: GET
#      request:
#        authorization: true
#        headers:
#          - "Content-Type: application/json" 
#      response:
#        headers:
#          - "Content-Type: application/json" 
#        status:
#          200:
#          400:
#        example: >
#          {
#              "bannerImageUrl": "https://buyexpressly.com/assets/banner/awesome-banner.jpg",
#              "migrationLink": "https://www.myblog.com/expressly/api/3aff1880-b0f5-45bd-8f33-247f55981f2c
#          }
- id: responses
  title: Responses
  description: Must be implemented for us to be able to talk to you.
  children:
    - id: responses_ping
      title: Ping Store
      template: rest_api/route.html
      description: Simple response message to note that the plugin has been installed
      route: /expressly/api/ping
      method: GET
      request:
        requester: SERVER
        headers:
          - "Content-Type: application/json"
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json" 
        status:
          200:
        example: >
          {
            "expressly": "Stuff is happening"
          }
    - id: responses_registered
      title: Token Check
      template: rest_api/route.html
      description: Simple response message to check that the API key / token has been configured correctly. The endpoint
       as with all the authenticated endpoints should return a 401 if the token part of the Authorization header does not
       match the stored token.
      route: /expressly/api/registered
      method: GET
      request:
        requester: SERVER
        authorization: true
        headers:
          - "Authorization: Basic &lt;API Token&gt;"
          - "Content-Type: application/json"
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json"
        status:
          200:
          401:
        example: >
          {
            "registered": true
          }
    - id: responses_popup
      title: Show Popup
      description: Start the user migration process. This uri should invoke the <a href="#requests_migration_popup">Get Campaign Migration Popup</a> request. The Popup can be shown over any page you wish, we recommend appending the html to your homepage.
      template: rest_api/route.html
      route: /expressly/api/{uuid}
      method: GET
      paramters:
        uuid: String
      request:
        requester: CUSTOMER
        headers:
          - N/A
      response:
        responder: STORE
        headers:
          - Content-Type "text/html"
    - id: responses_migrate_user
      title: Migrate User
      description: End of the user migration process. This uri should invoke the <a href="#requests_migration_data">Get Campaign Migration Data</a> request. The method should add all data for the provided user to the store, and if provided, add a product and/or coupon to the user's cart. The user should be logged in directly after this migration, and a welcome email (if not part of your store's initial flow) should be dispatched.
      template: rest_api/route.html
      route: /expressly/api/{uuid}/migrate
      method: GET
      parameters:
        uuid: String
      request:
        requester: CUSTOMER
        headers:
          - N/A
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json" 
        status:
          200:
          401:
        example: >
          {}
    - id: responses_user
      title: Retrieve User
      description: Return a users data, via your application facilities, conforming to our defined entities.
      template: rest_api/route.html
      route: /expressly/api/user/{email}
      method: GET
      parameters:
        email: String
      request:
        requester: SERVER
        authorization: true
        headers:
          - "Authorization: Basic &lt;API Token&gt;"
          - "Content-Type: application/json"
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json" 
        status:
          200:
          401:
        example: >
          {
              "meta": {
                  "locale": "UKR",
                  "sender": "https://yourstore.com/",
                  "issuerData": []
              },
              "data": {
                  "email": "john.smith@gmail.com",
                  "customerData": {
                      "firstName": "John",
                      "lastName": "Smith",
                      "gender": "M",
                      "billingAddress": 0,
                      "shippingAddress": 1,
                      "company": "Expressly",
                      "dob": "1987-08-07",
                      "taxNumber": "GB0249894821",
                      "onlinePresence": [
                          {
                              "field": "website",
                              "value": "www.myblog.com"
                          }
                      ],
                      "dateUpdated": "2015-07-10T11:42:00+01:00",
                      "dateLastOrder": "2015-07-10T11:42:00+01:00",
                      "numberOrdered": 5,
                      "emails": [
                          {
                              "email": "john.smith@gmail.com",
                              "alias": "default"
                          },
                          {
                              "email": "john@smithcorp.com",
                              "alias": "work"
                          }
                      ],
                      "phones": [
                          {
                              "type": "M",
                              "number": "020734581250",
                              "countryCode": 44
                          },
                          {
                              "type": "L",
                              "number": "020731443250",
                              "countryCode": 44
                          }
                      ],
                      "addresses": [
                          {
                              "firstName": "John",
                              "lastName": "Smith",
                              "address1": "12 Piccadilly",
                              "address2": "Room 14",
                              "city": "London",
                              "companyName": "WorkHard Ltd",
                              "zip": "W1C 34U",
                              "phone": 1,
                              "alias": "Work address",
                              "stateProvince": "LND",
                              "country": "GBR"
                          },
                          {
                              "firstName": "John C.",
                              "lastName": "Smith",
                              "address1": "23 Sallsberry Ave",
                              "address2": "Flat 3",
                              "city": "London",
                              "companyName": "",
                              "zip": "NW3 4HG",
                              "phone": 0,
                              "alias": "Home address",
                              "stateProvince": "LND",
                              "country": "GBR"
                          }
                      ]
                  }
              }
          }
    - id: responses_batch_invoices
      title: Invoices for Customer Purchases
      description: Given a list of date ranges and emails checks to see if the associated campaign users have had any transactions during the specified period. Used for auditing and tracking purposes.
      template: rest_api/route.html
      route: /expressly/api/batch/invoice
      method: POST
      request:
        requester: SERVER
        authorization: true
        headers:
          - "Authorization: Basic &lt;API Token&gt;"
          - "Content-Type: application/json"
        example: >
          {
              "customers": [
                  {
                      "email": "john.smith@gmail.com",
                      "from": "2015-07-01T00:00:00+00:00",
                      "to": "2015-08-01T00:00:00+00:00"
                  }
              ]
          }
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json" 
        status:
          200:
        example: >
          {
              "invoices": [
                  {
                      "email": "john.smith@gmail.com",
                      "orderCount": 1,
                      "preTaxTotal": 100.00,
                      "tax": 10.00,
                      "orders": [
                          {
                              "id": "ORDER-5321311",
                              "date": "2015-07-10T11:42:00+01:00",
                              "itemCount": 2,
                              "coupon": "",
                              "currency": "GBP",
                              "preTaxTotal": 100.00,
                              "postTaxTotal": 110.00,
                              "tax": 10.00
                          }
                      ]
                  }
              ]
          }
    - id: responses_batch_customers
      title: Customers on Store
      description: Given a list of emails, checks to see if a user already exists on the STORE or has completed the migration process successfully. Used for auditing and tracking purposes.
      template: rest_api/route.html
      route: /expressly/api/batch/customer
      method: POST
      request:
        requester: SERVER
        authorization: true
        headers:
          - "Authorization: Basic &lt;API Token&gt;"
          - "Content-Type: application/json"
        example: >
          {
              "emails": [
                  "john.smith@gmail.com",
                  "jane.smith@gmail.com"
              ]
          }
      response:
        responder: STORE
        headers:
          - "Content-Type: application/json" 
        status:
          200:
        example: >
          {
              "existing": [
                  "john.smith@gmail.com"
              ],
              "deleted": [],
              "pending": []
          }
