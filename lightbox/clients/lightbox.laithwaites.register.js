var xlyreg=xlyreg||{register:function(e,r){xlyreg.getTokenAndRegister(e,r)},getTokenAndRegister:function(e,r){jQuery.ajax({type:"GET",url:"/jsp/registration/common/account_new.jsp",success:function(i){var n=xlyreg.getToken(i);xlyreg.prepareRegistration(n,e,r)}})},getToken:function(e){var r=/<input[^>]+name="_dynSessConf"(?:[^>]+value="([^"]*)")[^>]*>/,i=r.exec(e);return i.length>1?i[1]:null},prepareRegistration:function(e,r,i){var n="undefined"!=typeof r.migration.data.customerData.billingAddress,a="undefined"!=typeof r.migration.data.customerData.shippingAddress,s=r.migration.data.customerData.addresses.length>0&&(n||a),t=s?r.migration.data.customerData.addresses[n?r.migration.data.customerData.billingAddress:r.migration.data.customerData.shippingAddress]:null;s?xlyreg.parseAddress(e,r,i,t):xlyreg.doRegistration(e,r,i,{})},doRegistration:function(e,r,i,n){var a=xlyreg.generatePassword(),s=r.migration.data.customerData.dob?!0:!1,t=s?new Date(r.migration.data.customerData.dob):null;jQuery.ajax({type:"POST",url:"/jsp/registration/common/account_new.jsp?_DARGS=/jsp/registration/uk/common/registrationDetails.jsp",data:{_dyncharset:"UTF - 8",_dynSessConf:e,wineplanFlag:"",axCustomerNumber:"",password:a,isBrandAcctValidated:!1,optInValue:!i,billingRadio_address_guest:!0,isNotVerificationRequired:!0,countryList:"#","gift-radio":0,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.email":r.migration.data.email,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.salutation:Mr":"F"===r.migration.data.customerData.gender?"Ms":"Mr","/dwint/userprofiling/DWINTRegistrationFormHandler.value.firstName":r.migration.data.customerData.firstName,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.lastName":r.migration.data.customerData.lastName,"/dwint/userprofiling/DWINTRegistrationFormHandler.confirmPassword":!0,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.confirmPassword":a,"/dwint/userprofiling/DWINTRegistrationFormHandler.day":s?t.getDate():null,"/dwint/userprofiling/DWINTRegistrationFormHandler.month":s?t.getMonth()+1:null,"/dwint/userprofiling/DWINTRegistrationFormHandler.year":s?t.getFullYear():null,"/dwint/userprofiling/DWINTRegistrationFormHandler.ukAddress":!0,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.companyName":n.original?n.original.companyName:null,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.houseNumber":n.houseNumber,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.flatNumber":n.flatNumber,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.houseName":n.houseName,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address1":n.address1,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address2":n.address2,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address3":"","/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.city":n.city,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.county":n.county,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.postalCode":n.postcode,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.state":null,"/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.dayPhoneNumber":n.phone,"/dwint/userprofiling/DWINTRegistrationFormHandler.createSuccessURL":"/jsp/account/common/account_details.jsp","/dwint/userprofiling/DWINTRegistrationFormHandler.createErrorURL":"/jsp/registration/common/account_new.jsp","/dwint/userprofiling/DWINTRegistrationFormHandler.create":"Create Account","_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.companyName":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.houseNumber":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.flatNumber":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.houseName":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address1":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address2":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.address3":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.city":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.county":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.postalCode":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.state":null,"_D:countryList":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.create":null,"_D:gift-radio":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.year":null,"_D:password":null,"_D:wineplanFlag":"","_D:axCustomerNumber":"","_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.email":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.salutation":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.firstName":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.lastName":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.confirmPassword":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.confirmPassword":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.day":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.month":null,"_D:isBrandAcctValidated":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.value.billingAddress.dayPhoneNumber":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.createSuccessURL":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.createErrorURL":null,"_D:optInValue":null,"_D:/dwint/userprofiling/DWINTRegistrationFormHandler.ukAddress":null,_DARGS:"/jsp/registration/uk/common/registrationDetails.jsp"},success:xlyreg.redirect})},cleanArray:function(e){for(var r=0;r<e.length;r++)e[r]||(e.splice(r,1),r--);return e},parseAddress:function(e,r,i,n){var a=n&&"undefined"!=typeof n.phone&&r.migration.data.customerData.phones.length>0,s={address1:n.address1,address2:n.address2,city:n.city,county:n.stateProvince,postcode:n.zip,phone:a?r.migration.data.customerData.phones[n.phone].number.replace(/\s/g,""):null,original:n},t=xlyreg.cleanArray([n.address1,n.address2,n.city,n.zip]).join(" ,");jQuery.ajax({type:"GET",url:"https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyBDALF2fhX2DBT9ZddfjyaapsvjNuq4dc4&address="+encodeURIComponent(t),success:function(n){var a=xlyreg.selectViableAddresses(n.results);if(1===a.length)for(var t=0;t<a[0].address_components.length;++t){var l=a[0].address_components[t];l.types.indexOf("subpremise")>-1?s.flatNumber=l.short_name:l.types.indexOf("premise")>-1?s.houseName=l.short_name:l.types.indexOf("street_number")>-1?s.houseNumber=l.short_name:l.types.indexOf("route")>-1&&(s.address1=l.short_name)}xlyreg.parseAddressContinue(e,r,i,s)},error:function(n){xlyreg.parseAddressContinue(e,r,i,s)}})},parseAddressContinue:function(e,r,i,n){if(!n.houseName&&!n.houseNumber){var a=xlyreg.findHouseNumber(n.original.address1);a?(n.houseNumber=a,n.address1=n.original.address1.substring(a.length,n.original.address1.length).replace(/^\s+|\s+$/gm,"")):(n.houseName=n.original.address1,n.address2&&(n.address1=n.address2,n.address2=null))}xlyreg.doRegistration(e,r,i,n)},findHouseNumber:function(e){var r=/^(\d+)\s.+$/,i=r.exec(e);return i.length>1?i[1]:null},selectViableAddresses:function(e){for(var r=0;r<e.length;r++){var i=e[r];i.types.indexOf("subpremise")<0&&i.types.indexOf("premise")<0&&i.types.indexOf("street_address")<0&&(e.splice(r,1),r--)}return e},redirect:function(e){e.indexOf("Sign Out")>-1?window.location.replace("https://prod.expresslyapp.com/api/redirect/migration/"+xlyrData.uuid+"/success"):e.indexOf("A user already exists with the login")>-1?(alert("You already have an account with this email address, redirecting you to login page"),window.location.replace("/jsp/registration/common/account_login.jsp")):window.location.replace("https://prod.expresslyapp.com/api/redirect/migration/"+xlyrData.uuid+"/failed")},generatePassword:function(e){for(var r=e?e:10,i="abcdefghijklmnopqrstuvwxyz",n="0123456789",a="!@#$%^&*()_+~`|}{[]:;?><,./-=",s="",t="";s.length<r;){var l=Math.ceil(i.length*Math.random()*Math.random()),o=Math.ceil(n.length*Math.random()*Math.random()),d=Math.ceil(a.length*Math.random()*Math.random()),u=i.charAt(l);u=l%2===0?u.toUpperCase():u,t+=u,t+=n.charAt(o),t+=a.charAt(d),s=t}return s}};
